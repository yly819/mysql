## 6.3.7 可插入身份式验证 ##

当一个客户端连接到MySQL服务器,服务器使用由客户提供用户名和客户端主机从`mysql.user`表中选择适当的账户行。服务器查询客户端使用的验证插件行,如下：

* 服务器决定通过查看从客户端身份验证插件的账户行:

	* 如果帐户行没有指定插件名称,服务器使用本地身份认证;那就是,身份验证的密码储存在账户行的`Password`栏。在MySQL服务5.5.7之前提供同样的身份验证方法,后来有了可插入式身份验证。
	
	* 如果帐户行指定了一个插件,服务器调用它来验证用户。如果服务器无法找到插件,则报错。

* 插件返回一个状态给服务器表示用户是否允许连接。

可插入身份验证允许的两个重要功能:

* 外部认证:可插入身份验证可以让客户连接MySQL服务器使用证书身份验证方法比基于本地身份验证把密码存储在`mysql.user`表更适全。例如,插件可以创建使用外部身份验证方法如PAM,Windows登录id、LDAP或Kerberos。

* 代理用户:如果一个用户被允许连接,一个身份验证插件可以给服务器返回不同的名字的用户名作为连接用户,表明连接用户是一个被代理用户。而连接过程中,作为代理用户对待，通过访问控制,有一个不同的用户的特权。实际上,一个用户扮演另一个用户。关于更多相关信息,请参见[6.3.8,“代理用户”][06.03.08]。

在MySQL上可用的身份验证插件:

* 插件执行本地身份验证密码匹配账户行的`Password`栏。`mysql_native_password`插件实现了身份验证的基于本地密码哈希加密算法。`mysql_old_password`插件实现了本地身份验证基于旧(pre-4.1)密码哈希加密算法(现在已不使用)。参考[6.3.7.2,“本地身份验证插件”][06.03.07.02],参考[6.3.7.3,The “Old” Native Authentication Plugin”][06.03.07.03]。如果帐户行没有明确使用的插件，本地身份验证默认给账号使用`mysql_native_password`,除非服务器启用`--default-authentication-plugin`选项来改变默认的插件。

* 一个插件使用sha-256的密码哈希算法执行身份验证。这个插件使用密码匹配账户行的`authentication_string`列。这个强大的加密比本地身份验证更实用。参考[6.3.7.4,“sha - 256身份验证插件”][06.03.07.04]。

* 一个插件执行外部身份验证对PAM(可插入身份验证模块), 支持MySQL服务器使用PAM身份验证MySQL用户。这个插件也支持代理用户。参考[6.3.7.5,”PAM身份验证插件”][06.03.07.05]。

* 一个插件在Windows上执行外部身份验证,让MySQL服务器启用本机Windows服务给客户端连接进行身份验证。用户登录到Windows，然后可以基于他们的环境连接到服务器MySQL客户程序,且没有另外指定一个密码。这个插件支持代理用户。参考[6.3.7.6,“Windows本地身份验证插件”][06.03.07.06]。

* 一个客户端插件发送密码给服务器没有哈希算法或加密。这个插件可以使用服务器端插件,需要客户端用户访问提供完全一样的密码。参考[6.3.7.7”,明文发送客户端身份验证插件”][06.03.07.07]。

* 一个插件对客户端进行身份验证,从本地主机通过Unix socket文件连接。参考[6.3.7.8,“套接字对等凭据的身份验证插件”][06.03.07.08]。

* 一个测试插件使用MySQL本地身份验证进行身份验证。这个插件以测试和开发的目的,有一个例子,如何写身份验证插件。参考[6.3.7.9,“测试验证插件”][06.03.07.09]。

关于如何使用身份验证插件的相关信息,参考[6.3.7.1,“身份验证插件的使用说明”][06.03.07.01]。

> **注意**
>
>关于限制使用可插入身份验证的信息,包括这连接器支持哪个插件,参考[E.9,“限制可插入身份验证”][E.09]。
>
>第三方连接器的开发人员应该读这部分的连接器来确定连接器可以利用可插入身份验证功能和将采取什么措施变得更加兼容。

如果你有兴趣编写自己的身份验证插件,参考[23.2.4.9,“写身份验证插件”][23.02.04.09]。

#### 6.3.7.1 身份验证插件的使用说明 ####

本节提供了安装和使用身份验证插件的用法说明。

一般来说,在服务器和客户端可插入身份验证会使用相应的插件,所以你使用一个给定的身份验证方法参考如下:

* 在服务器主机,安装库包含适当的服务器插件,如果有必要,服务器可以使用它来验证客户端连接。同样,在每个客户端主机,安装库包含适当的客户端插件给客户端程序使用。

* 创建MySQL账户,指定使用的身份验证插件。

* 当一个客户端连接,服务器插件告诉客户端程序,客户端插件使用身份验证。

有一个在MySQL上使用验证插件的例子(参考[6.3.7.9,“测试验证插件”][06.03.07.09])。过程与其他身份验证插件是类似的;替代相应的插件和文件名称即可。

例举验证插件的特点:

* 服务器端插件名为`test_plugin_server`。

* 客户端插件名为`auth_test_plugin`。

* 这两个插件都位于共享库的插件目录，对象文件名为`auth_test_plugin.so`(目录指定的`plugin_dir`系统变量)。文件名称在不同的系统,可能会有不同的后缀。

安装和使用身份验证插件的示例如下:

1.确保在服务器和客户端主机已安装插件库。

2.安装服务器端测试插件在服务器启动或运行时:

*  在启动时安装插件,使用`--plugin-load`选项。用这个插件加载法,每次启动服务器必须给出选项。例如,使用这些行在`my.cnf`文件中:

```sql
    [mysqld]
	plugin-load=test_plugin_server=auth_test_plugin.so
```

* 在运行时候安装该插件,使用`INSTALL PLUGIN`语句:

```sql
    mysql> INSTALL PLUGIN test_plugin_server SONAME 'auth_test_plugin.so';
```

安装插件永久性和一次性都需要做以上步骤。

3.验证插件是否安装。例如,使用`SHOW PLUGINS`:

```sql
    mysql> SHOW PLUGINS\G
	...
	*************************** 21. row ***************************
	Name: test_plugin_server
	Status: ACTIVE
	Type: AUTHENTICATION
	Library: auth_test_plugin.so
	License: GPL
```

对于其他方法来检查插件,参考[5.1.8.2”,获取服务器插件信息”][05.01.08.02]。

4.指定一个MySQL用户必须使用指定服务器插件来身份验证,`CREATE USER`创建用户在`IDENTIFIED WITH`语句后面带上插件的名称:

```sql
    CREATE USER 'testuser'@'localhost' IDENTIFIED WITH test_plugin_server;
```

5.连接到服务器使用一个客户端程序。测试插件验证同样的方式作为本地MySQL身份验证,所以提供常用的`--user`和`--password`选项,用来连接到服务器。例如:

```sql
    shell> mysql --user=your_name --password=your_pass
```

使用`testuser`用户连接,服务器看到帐户必须使用`test_plugin_server`身份验证，服务器端插件和客户端通信程序，在这种情况下必须使用`auth_test_plugin`。

如果帐户使用的身份验证方法是服务器和客户端程序默认的,服务器不需要跟客户端通信插件的使用,往返在客户机/服务器谈判是可以避免的。真实账户使用本地MySQL身份验证(`mysql_native_password`)。

`--default-auth=plugin_name`选项可以指定在mysql命令行明确指出客户端插件程序是否启用,尽管服务器将覆盖这个默认指定，如果用户帐户需要一个不同的插件。

如果客户端程序没有找到插件,指定一个`--plugin-dir=dir_name`选项指定插件的位置。

>**注意**
>
>如果您启动服务器使用`--skip-grant-tables`选项,身份验证插件没有使用，即使加载了,因为服务器没有执行客户端身份验证和允许任何客户机连接。因为这是不安全的,你可能需要使用`--skip-grant-tables`和`--skip-networking`连接使用防止远程客户端连接。

#### 6.3.7.2. 本地身份验证插件 ####

MySQL包括两个插件,实现本地认证;也就是说,认证不通过存储密码在`mysql.user`表的`Password`栏。本节描述`mysql_native_password`,它实现身份验证不通过`mysql.user`表使用本地密码哈希算法。关于`mysql_old_password`的更多信息,实现身份验证使用老的(pre-4.1)密码哈希算法,参考[6.3.7.3,”The “Old” Native Authentication Plugin”][06.03.07.03]。关于密码哈希算法的信息,请参考[6.1.2.4,“MySQL密码哈希算法”][06.01.02.04]。

`mysql_native_password`身份认证插件是向后兼容的。客户端的版本比MySQL 5.5.7老的话不支持身份验证插件，但可以使用本地身份验证协议, 所以他们可以连接到MySQL服务器使用5.5.7和5.5.7以上的版本。

下面的表显示了在服务器和客户端插件的名称。

**表6.8. MySQL本机密码身份验证插件**

<table><colgroup><col><col></colgroup><tbody><tr><td scope="row">服务器端插件名字</td><td><code class="literal">mysql_native_password</code></td></tr><tr><td scope="row">客户端插件名字</td><td><code class="literal">mysql_native_password</code></td></tr><tr><td scope="row">库对象文件的名字</td><td>None (plugins are built in)</td></tr></tbody></table>
</div>

插件在客户端和服务器端都存在: 　　

* 服务器端插件安装在服务器端,不需要显式地加载,无法被禁用除非通过卸载它。　
　
* 客户端插件在MySQL 5.5.7版本是内置在`libmysqlclient`客户端库和可用于任何程序对`libmysqlclient`版本或更新的版本。　　

* MySQL客户端程序使用`mysql_native_password`默认情况下。`--default-auth`选项可以用来明确指定插件:

```sql
    shell> mysql --default-auth=mysql_native_password ...
```

对于一般的信息可插入身份验证MySQL,参考[6.3.7,“可插入身份验证”][06.03.07]。

#### 6.3.7.3. The “Old” Native Authentication Plugin ####

MySQL包括两个插件,实现本地认证;也就是说,认证对密码存储在密码栏的`mysql.user`表。本节描述`mysql_old_password`,它实现身份验证对`mysql.user`表使用老(pre - 4.1)密码哈希算法。对于信息的`mysql_native_password`,实现身份验证使用本机密码哈希算法,看到部分[6.3.7.3,” “The Old” Native Authentication Plugin”][06.03.07.03]。对于这些密码哈希算法的信息,请参考[6.1.2.4,“MySQL密码哈希算法”][06.01.02.04]。

>注意
>
>密码,使用pre -4.1哈希算法的安全性也低于使用本机密码哈希算法的密码。这是可以避免的，pre-4.1密码在以后的MySQL版本中被放弃和不支持。

本地认证的`mysql_old_password`是向后兼容的。客户端版本低于MySQL 5.5.7不支持身份验证插件，但可以使用本地身份验证协议,所以们可以连接到MySQL服务器5.5.7和5.5.7以上版本。

下面的表显示了在服务器和客户端的插件名称。

**Table 6.9. MySQL “Old” Native Authentication Plugin**

<table><colgroup><col><col></colgroup><tbody><tr><td scope="row">服务器端插件名字</td><td><code class="literal">mysql_old_password</code></td></tr><tr><td scope="row">客户端插件名字</td><td><code class="literal">mysql_old_password</code></td></tr><tr><td scope="row">库对象文件的名字</td><td>None (plugins are built in)</td></tr></tbody></table>
</div>

插件在客户机和服务器中都存在:

* 服务器端插件是安装在服务器上,不需要显式地加载,无法被禁用只能卸载它。

* 库自MySQL的5.5.7起客户端插件是内置在`libmysqlclient`客户端库和任何程序都连接不通过`libmysqlclient`的版本或更新的版本。

* MySQL客户端程序可以使用`—--default-auth`选项来明确指定`mysql_old_password`插件:

```sql
    shell> mysql --default-auth=mysql_old_password ...
```

关于MySQL可插入身份验证的相关信息,参考[6.3.7,“可插入身份验证”][06.03.07]。

#### 6.3.7.4. sha-256认证的插件 ####

在MySQL 5.6.6中,MySQL提供身份验证插件,实现了用户帐户的密码使用sha-256哈希算法。

>**重要提示**
>
>连接到服务器的帐户使用的身份验证是`sha256_password`插件,您必须使用一个SSL连接或简单连接,使用RSA加密密码,在后面会讲到。无论哪种方式,使用`sha256_password`插件要求MySQL必须安装SSL功能.参考[6.3.9”,使用SSL的安全连接“][06.03.09]。

下面的表显示了在服务器和客户端插件的名称。

<div class="table">
<a name="idm47087463252368"></a><p class="title"><b>Table 6.10. MySQL SHA-256 Authentication Plugin</b></p>
<div class="table-contents">
<table><colgroup><col><col></colgroup><tbody><tr><td scope="row">服务端插件名称</td><td><code class="literal">sha256_password</code></td></tr><tr><td scope="row">客户端插件名称</td><td><code class="literal">sha256_password</code></td></tr><tr><td scope="row">库对象文件名称</td><td>None (plugins are built in)</td></tr></tbody></table>
</div>

服务器端安装`sha256_password`插件,不需要显式地加载,不能被禁用的只能卸载它。同样的,客户端不需要指定客户端插件的位置。

创建一个帐号,指定他认证方式使用`sha-256`密码哈希算法,参考以下步骤。　　

1.创建帐户和指定验证使用`sha256_password`插件:

```sql
    CREATE USER 'sha256user'@'localhost' IDENTIFIED WITH sha256_password;
```

2.设置`old_passwords`系统变量值为2，让`PASSWORD()`函数功能对密码字符串使用sha-256哈希算法:

```sql
    SET old_passwords = 2;
```

3.设置账户密码:

```sql
    SET PASSWORD FOR 'sha256user'@'localhost' = PASSWORD('sha256P@ss');
```

或者,启动服务器身份验证插件的默认设置为`sha256_password`。举一个例子,把这几行配置写在服务器配置文件中:

```sql
    [mysqld]
	default-authentication-plugin=sha256_password
```

这会让新账户默认使用`sha256_password`插件和设置`old_passwords`为2。因此,在创建帐户并设置密码的时候使用`CREATE USER`语句及`IDENTIFIED BY`项:

```sql
    mysql> CREATE USER 'sha256user2'@'localhost' IDENTIFIED BY 'sha256P@ss2';
	Query OK, 0 rows affected (0.06 sec)
```

在这种情况下,服务器分配`sha256_password`插件给指定帐户和密码加密使用sha-256。(另外一种结果是,创建一个帐户,使用一个不同的身份验证插件,您必须指定插件使用`CREATE USER`语句及`IDENTIFIED BY`子句,然后插件正确地设置`old_passwords`，在使用`SET PASSWORD`设置账户密码前。)

如果`old_passwords`的值而不是2,会有一个试图用sha-256设置帐户的密码的报错:

```sql
    mysql> SET old_passwords = 0;
	mysql> SET PASSWORD FOR 'sha256user'@'localhost' = PASSWORD('sha256P@ss');
	ERROR 1827 (HY000): The password hash doesn't have the expected format.
	Check if the correct password algorithm is being used with the
	PASSWORD() function.
```

了解`old_passwords` 和`PASSWORD`更多相关信息，请参考[5.1.4章,“服务器系统变量”][05.01.04],还有[12.13章，“加密和压缩功能”][12.13]。

账户在`mysql.user`表中,使用`sha-256`的密码可以被鉴别在`plugin`列的`sha256_password`栏和`sha-256`哈希算法密码在`authentication_string`栏。

MySQL可以安装使用yaSSL或OpenSSL和`sha256_password`插件可以使用分布安装也可以使用安装包。默认使用yaSSL。如果MySQL创建使用OpenSSL安装,可以使用RSA加密,并且`sha256_password`实现以下列表中附加功能。(使这些功能,你也必须遵循RSA配置过程可参考本节后面讲述。)

* 它是可能的客户端发送密码给服务器，密码在客户端连接过程中使用RSA加密,后面会描述到。

* 服务器公开了两个附加的系统变量,`sha256_password_private_key_path` 和 `sha256_password_public_key_path` 其目的是,在服务器启动的时候，数据库管理员会设置RSA的私钥和公钥的文件名。

* 服务器公开了一个状态变量,`Rsa_public_key`,显示RSA公钥值。

* `mysql`和`mysqltest`客户程序支持`--server-public-key-path`语句用于明确的指定一个RSA公钥文件。(这个选项在MySQL 5.6.6被添加`--server-public-key`和在5.6.7更名为`--server-public-key-path`。)

对于客户使用`sha256_password`插件,当连接到服务器绝不会暴露明文密码。密码怎么传输取决于SSL连接是否被使用和RSA加密是否可用:

* 如果SSL连接被使用,密码是明文发送但不能监听,因为连接是使用SSL加密。

* 如果不能使用SSL连接，但是RSA加密的可用的,密码发送使用的是未加密的连接,但是密码是rsa加密的防止窃听。当服务器收到密码,然后进行解密。使用加密方法登录防止重复攻击。

* 如果SSL连接不能被使用,并且RSA加密不可用,会导致`sha256_password`插件连接失败,因为密码不能以明文发送发送否则会暴露密码。

如前所述,只有MySQL建成使用OpenSSL，RSA密码加密才可用。这意味着,在MySQL建立使用yaSSL，只有当客户使用SSL连接访问服务器，sha-256密码才能被使用。关于使用SSL连接到服务器的更多信息,请参考[6.3.9章,“使用SSL进行安全连接”][06.03.09]。

假定MySQL构建已使用OpenSSL,下列步骤描述了在客户端连接过程中如何启用RSA密码加密:

1. 创建RSA私钥和公钥文件。登录到系统后运行这些命令，同时帐户用于运行MySQL服务器,文件归该帐户拥有:

```sql
	openssl genrsa -out mykey.pem 1024
	openssl rsa -in mykey.pem -pubout > mykey.pub
```

2. 设置key文件的访问模式。私钥应该是只有通过服务器是可读的:

```sql
    chmod 400 mykey.pem
```

公钥可以自由分发到客户端用户:

```sql
    chmod 444 mykey.pub
```

3. 在服务器配置文件中,给key文件配置适当的系统变量的名称。如果您将文件放入服务器数据目录,您不需要指定完整路径名称:

```sql
    [mysqld]
	sha256_password_private_key_path=mykey.pem
	sha256_password_public_key_path=mykey.pub
```

如果文件不是在数据目录,或使用具体位置选项值,使用完整路径名称:

```sql
    [mysqld]
	sha256_password_private_key_path=/usr/local/mysql/mykey.pem
	sha256_password_public_key_path=/usr/local/mysql/mykey.pub	
```

4.重启服务器,然后连接到它并检查`Rsa_public_key`状态变量值。与这里显示的该值会所不同,,但是应该非空的:

```sql
    mysql> SHOW STATUS LIKE 'Rsa_public_key'\G
	*************************** 1. row ***************************
	Variable_name: Rsa_public_key
		Value: -----BEGIN PUBLIC KEY-----
	MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDO9nRUDd+KvSZgY7cNBZMNpwX6
	MvE1PbJFXO7u18nJ9lwc99Du/E7lw6CVXw7VKrXPeHbVQUzGyUNkf45Nz/ckaaJa
	aLgJOBCIDmNVnyU54OT/1lcs2xiyfaDMe8fCJ64ZwTnKbY2gkt1IMjUAB5Ogd5kJ
	g8aV7EtKwyhHb0c30QIDAQAB
		-----END PUBLIC KEY-----
```

如果该值为空,服务器的key文件有问题。检查错误日志的诊断信息。

在服务器已经配置了RSA密钥文件,客户端能够使用账户连接到它，这验证了`sha256_password`插件。正如前面提到的,这种账户可以使用SSL连接(在这种情况下不使用RSA)或使用RSA加密密码的普通连接,。假设下面的讨论,没有使用SSL，连接到服务器，在客户端不需要特殊准备。例如:

```sql
    shell> mysql -u sha256user -p
	Enter password: sha256P@ss
```

使用`sha256user`尝试连接,服务器确定`sha256_password`是可用的身份验证插件和调用它。插件发现连接没有使用SSL，因而需要密码是使用RSA加密传输。它传递了RSA公钥客户端，使用它来加密的密码,并将结果返回给服务器。插件使用了RSA密钥在服务器端解密密码，并接受或拒绝连接请求，取决于密码是否正确的。

服务器发送到客户机的公钥是这是有必要的,但如果有可用的RSA公钥副本在客户端主机上,客户端保存并使用它，节省了在客户机/服务器协议往返的时间:

```sql
    shell> mysql -u sha256user -p --server-public-key-path=file_name
```

公钥值的文件命名为`--server-public-key-path`选项，在服务器端应该有一样的key值文件名为`sha256_password_public_key_path`系统变量。如果密钥文件包含一个有效公钥，但值是不正确的,发生拒绝访问的报错。如果密钥文件不包含一个有效的公钥,客户端程序不能使用它。在这种情况下,服务器发送公钥给客户端，如果没有`--server-public-key-path`选项被指定的话。

客户端用户可以得到RSA公钥的两种方式:

* 数据库管理员可以提供一份公钥文件。

* 客户端用户通过其他的方式连接到服务器，使用`SHOW STATUS LIKE 'Rsa_public_key'`语句，保存返回的key值到一个文件中。